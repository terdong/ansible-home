---
- name: Install Zsh and Git
  apt:
    name: [zsh, git, curl]
    state: present

- name: Install Oh My Zsh
  shell: |
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  become_user: "{{ ansible_user }}"
  args:
    creates: "{{ user_home_dir }}/.oh-my-zsh"

- name: Download Zsh Plugins
  git:
    repo: "{{ item.repo }}"
    dest: "{{ user_home_dir }}/.oh-my-zsh/custom/plugins/{{ item.name }}"
  become_user: "{{ ansible_user }}"
  loop:
    - {
        name: "zsh-autosuggestions",
        repo: "https://github.com/zsh-users/zsh-autosuggestions",
      }
    - {
        name: "zsh-syntax-highlighting",
        repo: "https://github.com/zsh-users/zsh-syntax-highlighting.git",
      }

- name: Set Zsh Theme to 'macovsky-ruby'
  lineinfile:
    path: "{{ user_home_dir }}/.zshrc"
    regexp: "^ZSH_THEME="
    line: 'ZSH_THEME="macovsky-ruby"'

- name: Configure .zshrc
  lineinfile:
    path: "{{ user_home_dir }}/.zshrc"
    regexp: "^plugins="
    line: "plugins=(git zsh-autosuggestions zsh-syntax-highlighting)"

- name: Add time to macovsky-ruby theme
  lineinfile:
    path: "{{ user_home_dir }}/.zshrc"
    line: 'PROMPT="[%D{% raw %}{%H:%M:%S}{% endraw %}] $PROMPT"'
    insertafter: EOF

- name: Add neofetch
  lineinfile:
    path: "{{ user_home_dir }}/.zshrc"
    line: "neofetch"
    insertafter: EOF

- name: Set Default Shell to Zsh
  user:
    name: "{{ ansible_user }}"
    shell: /bin/zsh
